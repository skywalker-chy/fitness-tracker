# 🧪 InsForge 认证系统测试指南

本文档说明如何测试完整的 InsForge 认证系统。

## 📋 测试清单

### ✅ 必须测试的功能

- [ ] **注册功能**
  - [ ] 使用有效邮箱和密码注册
  - [ ] 注册后自动登录
  - [ ] 重复邮箱注册应该失败
  - [ ] 弱密码应该被拒绝

- [ ] **登录功能**
  - [ ] 使用正确的邮箱和密码登录
  - [ ] 错误的邮箱应该失败
  - [ ] 错误的密码应该失败
  - [ ] 登录后访问令牌应该保存

- [ ] **登出功能**
  - [ ] 点击登出按钮
  - [ ] 令牌应该被清除
  - [ ] 应该重定向到登录页面

- [ ] **令牌管理**
  - [ ] 令牌应该包含在 API 请求头中
  - [ ] 过期的令牌应该被刷新
  - [ ] 刷新失败应该强制重新登录

- [ ] **路由保护**
  - [ ] 未登录用户无法访问主应用
  - [ ] 登录用户可以访问所有页面
  - [ ] 登出后应该回到登录页

- [ ] **数据访问**
  - [ ] 登录后可以加载账户列表
  - [ ] 登录后可以加载交易列表
  - [ ] 无效令牌的请求应该失败

---

## 🚀 快速开始测试

### 步骤 1: 启动开发服务器

```bash
cd bill-main_V1.1
npm run web -- --port 8085
```

### 步骤 2: 打开浏览器

访问 http://localhost:8085

### 步骤 3: 查看日志

打开浏览器控制台（F12）查看：
- `[Auth Store]` - 认证操作日志
- `[InsForge]` - API 调用日志
- 错误信息

---

## 🧪 详细测试步骤

### 测试 1: 注册新用户

**步骤：**

1. 打开应用，应该看到登录页面
2. 点击 "Sign Up Now" 链接
3. 输入以下信息：
   - 名称：`Test User`
   - 邮箱：`testuser@example.com`
   - 密码：`password123`
   - 确认密码：`password123`
4. 点击 "Sign Up" 按钮

**预期结果：**
- 看到加载状态
- 注册成功后自动登录
- 自动重定向到主应用
- 看到用户名和邮箱显示在顶部

**浏览器控制台应该显示：**
```
[Auth Store] Signing up user: testuser@example.com
[InsForge] POST /auth/signup
[Auth Store] Sign up successful
```

### 测试 2: 登录用户

**步骤：**

1. 点击 "Don't have an account? Sign Up Now"
2. 使用同一邮箱注册另一个账户，或点击返回登录
3. 在登录页面输入：
   - 邮箱：`testuser@example.com`
   - 密码：`password123`
4. 点击 "Sign In" 按钮

**预期结果：**
- 看到加载状态
- 登录成功
- 自动重定向到主应用
- 看到用户信息

**浏览器控制台应该显示：**
```
[Auth Store] Signing in user: testuser@example.com
[InsForge] POST /auth/signin
[Auth Store] Sign in successful
```

### 测试 3: 错误处理

**步骤（邮箱错误）：**

1. 在登录页面输入：
   - 邮箱：`wrongemail@example.com`
   - 密码：`password123`
2. 点击 "Sign In"

**预期结果：**
- 看到错误消息："Invalid email or password"
- 不能登录，停留在登录页面

**浏览器控制台应该显示：**
```
[Auth Store] Sign in error: Invalid email or password
```

### 测试 4: 密码验证

**步骤（密码太短）：**

1. 在注册页面输入：
   - 名称：`Test User`
   - 邮箱：`test@example.com`
   - 密码：`123` (少于 6 字符)
   - 确认密码：`123`
2. 点击 "Sign Up"

**预期结果：**
- 看到警告信息："Password must be at least 6 characters"
- 不能提交表单

### 测试 5: 密码确认不匹配

**步骤：**

1. 在注册页面输入：
   - 名称：`Test User`
   - 邮箱：`test@example.com`
   - 密码：`password123`
   - 确认密码：`password456` (不匹配)
2. 点击 "Sign Up"

**预期结果：**
- 看到警告信息："Passwords do not match"
- 不能提交表单

### 测试 6: 登出功能

**步骤：**

1. 登录到应用
2. 进入 "Profile" 页面
3. 点击 "退出登录" (Logout)
4. 在确认对话框中点击 "确定"

**预期结果：**
- 登出成功
- 自动重定向到登录页面
- 令牌被清除

**浏览器控制台应该显示：**
```
[Auth Store] Sign out error: (可能有错误，这是正常的)
```

### 测试 7: 令牌包含在 API 请求中

**步骤：**

1. 登录到应用
2. 打开浏览器的 Network 标签
3. 进入某个页面（比如 Wallet）
4. 查看 API 请求的请求头

**预期结果：**
- 在请求头中看到：`Authorization: Bearer eyJ...`
- API 请求应该成功返回数据

### 测试 8: 路由保护

**步骤：**

1. 在浏览器地址栏输入：`http://localhost:8085`
2. 应该看到登录页面
3. 尝试访问：`http://localhost:8085/wallet`（或任何标签页面）

**预期结果：**
- 未登录时应该重定向到登录页面
- 登录后可以访问所有页面

### 测试 9: 浏览器刷新后的持久化

**步骤：**

1. 登录到应用
2. 刷新页面（F5 或 Ctrl+R）

**预期结果：**
- 应该保持登录状态（如果配置了持久化）
- 或者回到登录页面（如果使用内存存储）

**注意：** 目前使用内存存储，刷新后会返回登录页面。生产环境应使用 localStorage 或 KeyChain。

### 测试 10: 令牌刷新

**步骤：**

1. 登录到应用
2. 等待令牌即将过期（或手动修改过期时间进行测试）
3. 执行 API 请求

**预期结果：**
- 如果有刷新令牌，应该自动刷新
- 请求继续成功
- 用户不会感觉到中断

---

## 🔍 浏览器控制台调试

### 查看认证状态

在浏览器控制台输入：

```javascript
// 查看当前认证状态
import { useAuthStore } from '@/store/useAuthStore';
const state = useAuthStore.getState();
console.log('Auth State:', state);

// 查看用户信息
console.log('User:', state.user);

// 查看令牌
console.log('Token:', state.token);

// 查看是否已登录
console.log('Is Signed In:', state.isSignedIn);
```

### 手动测试 API

```javascript
// 测试登录
const result = await useAuthStore.getState().signIn('test@example.com', 'password123');
console.log('Login result:', result);

// 测试登出
await useAuthStore.getState().signOut();
```

---

## 📊 测试结果记录

### 测试 1: 注册功能
- **日期：** ___________
- **结果：** ☐ 通过 ☐ 失败
- **注释：** _______________________________

### 测试 2: 登录功能
- **日期：** ___________
- **结果：** ☐ 通过 ☐ 失败
- **注释：** _______________________________

### 测试 3: 登出功能
- **日期：** ___________
- **结果：** ☐ 通过 ☐ 失败
- **注释：** _______________________________

### 测试 4: 令牌管理
- **日期：** ___________
- **结果：** ☐ 通过 ☐ 失败
- **注释：** _______________________________

### 测试 5: 路由保护
- **日期：** ___________
- **结果：** ☐ 通过 ☐ 失败
- **注释：** _______________________________

### 测试 6: 数据访问
- **日期：** ___________
- **结果：** ☐ 通过 ☐ 失败
- **注释：** _______________________________

---

## 🐛 常见问题排查

### 问题：注册后看不到用户信息

**排查步骤：**
1. 检查浏览器控制台是否有错误
2. 检查网络请求是否成功（Network 标签）
3. 检查响应数据格式是否正确
4. 清除浏览器缓存重试

### 问题：登录失败，但浏览器控制台没有错误

**排查步骤：**
1. 检查邮箱和密码是否正确
2. 检查网络连接
3. 检查 InsForge API 是否在线
4. 查看 Network 标签中的响应

### 问题：API 请求返回 401 错误

**排查步骤：**
1. 检查令牌是否存在：`useAuthStore.getState().token`
2. 检查令牌是否正确格式化：`Authorization: Bearer {token}`
3. 检查令牌是否过期
4. 尝试手动刷新令牌

### 问题：登出后仍然可以访问应用

**排查步骤：**
1. 清除浏览器缓存
2. 检查 isSignedIn 是否被正确设置为 false
3. 检查路由条件是否正确
4. 刷新页面

---

## ✅ 完整测试检查清单

### 前端测试

- [ ] UI 页面加载正确
- [ ] 表单验证工作正常
- [ ] 错误消息显示清楚
- [ ] 加载状态显示正确
- [ ] 动画和过渡流畅
- [ ] 响应式设计工作
- [ ] 深色/浅色主题切换
- [ ] 国际化文本正确

### 认证测试

- [ ] 注册新用户成功
- [ ] 登录用户成功
- [ ] 登出用户成功
- [ ] 错误处理正确
- [ ] 表单验证正确
- [ ] 令牌正确管理
- [ ] 刷新令牌工作

### API 测试

- [ ] 认证端点响应正确
- [ ] 数据端点需要令牌
- [ ] 无效令牌被拒绝
- [ ] 过期令牌被刷新
- [ ] 错误响应处理正确
- [ ] 请求头格式正确

### 路由测试

- [ ] 未登录用户被重定向
- [ ] 登录用户可以访问所有页面
- [ ] 登出后回到登录页面
- [ ] 路由转换流畅

### 浏览器兼容性

- [ ] Chrome 最新版本
- [ ] Firefox 最新版本
- [ ] Safari 最新版本
- [ ] Edge 最新版本
- [ ] 移动浏览器

---

**测试完成日期：** ___________  
**测试人员：** ___________  
**结果：** ☐ 全部通过 ☐ 部分通过 ☐ 失败

**备注：** _________________________________________________________
